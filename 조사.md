# OpenWeatherMap API 를 이용하여 필요한 날씨 관련 데이터를 받아온다 

API는 정의 및 프로토콜 집합을 사용하여 두 소프트웨어 구성 요소가 서로 통신할 수 있게 하는 메커니즘입니다.

 예를 들어, 기상청의 소프트웨어 시스템에는 일일 기상 데이터가 들어 있습니다. 휴대폰의 날씨 앱은 API를 통해 이 시스템과 ‘대화’하여 휴대폰에 매일 최신 날씨 정보를 표시합니다..

(github.com)](https://github.com/michael-lynch/open-weather)

```
40,000개 이상의 기상 관측소의 데이터 기반으로 업데이트 된 70,000도시의 현재 날씨 정보를 제공한다. 
```



API 라이센스는 ODbL (**Open Database License (ODbL)**)

- 데이터베이스의 자유로운 공유, 수정, 사용을 허용하는 카피레프트 라이선스



API 사용 방법.()

1.먼저 OpenWeatherMap사이트(https://openweathermap.org)에 접속합니다.

2.간단한 회원 가입을 마친 후 API keys를 누르게 되면  

3.API Key를 얻을수 있는 페이지로 들어가지며  key를 받게 되면그 키를 복사 하면 초기 단계는 모두 끝이 난다.

4. 소스코드의 자신이 복사한 키를 #define VARLD에 붙여 넣습니다. ![2022-11-16 15;53;29](C:\Users\Jun\Desktop\2022-11-16 15;53;29.PNG)

(설명 )

#define VARLD "키 입력" 입니다.

(MAP API의 사용법을 알기 위해서 1번에  홈페이지에서 )

 상단의 메뉴 API 를 클릭하여 자신의 선택에따라 

현재의 날씨데이터를 받아온다면 Current Weaher Data의 API doc을 클릭합니다. 

![2022-11-16 16;00;23](C:\Users\Jun\Desktop\2022-11-16 16;00;23.PNG)

(다음)

By city name 의 API call을 확인 합니다.

이는 도시이름과 복사한 api 키값이 존재하면 api를 호출 하여 데이터를 받을 수 있음을 알려줍니다. 

<아두이노>

![2022-11-16 16;05;00](C:\Users\Jun\AppData\Roaming\Typora\typora-user-images\image-20221116160512405.png)

```
#include "WizFi360.h"

#define SERIAL_BAUDRATE   115200
#define SERIAL1_BAUDRATE  115200

#define VARID  "9cbe77b703b0c172de8e80ade55ae511" //복사한 키값 입력 

//상단 부분의 사용하는 와이파이 아이디 비번 을 입력합니다. 
char ssid[] = "nepes_wireless_guest";
char pass[] = "gu@st12345";
int status = WL_IDLE_STATUS;

char server[] = "api.openweathermap.org";  // Openweathermap API 주소를 나타냅니다.

//서버의 접속 시간을 저장합니다.
unsigned long lastConnectionTime = 0;         // 서버에 접속한 마지막 시간 (MilliSecond)
const unsigned long postingInterval = 10000L; // 서버에 데이터를 요청할 Delay (MilliSecond)

boolean readingVal;
boolean getIsConnected = false;
int val, temp;
int tempVal;
int pos = 0;
int count = 0;

String rcvbuf;

// WiFiClient 오브젝트 선언        
WiFiClient client;

void httpRequest();
void printWifiStatus();

void setup() {
  // initialize serial for debugging
  Serial.begin(SERIAL_BAUDRATE);
  // initialize serial for WizFi360 module
  Serial3.begin(SERIAL1_BAUDRATE);
  // initialize WizFi360 module
  WiFi.init(&Serial3);

  if (WiFi.status() == WL_NO_SHIELD) {  // WiFi보드에 문제가 있다면
    Serial.println("WiFi board error");  // 시리얼 모니터에 WiFi board error 출력
    while (true);
  }

  while ( status != WL_CONNECTED) {
    Serial.print("Attempting to connect to WPA SSID: ");
    Serial.println(ssid);

    status = WiFi.begin(ssid, pass);
  }

  Serial.println("You're connected to the network");
  printWifiStatus();
}

void loop() {
  String rcvbuf;
  String valString;
  while (client.available()) {

    if ( rcvbuf.endsWith("{\"temp\":")) {
      readingVal = true;
      valString = "";
    }

    char c = client.read();
    //Serial.write(c);


    if ( c != NULL ) {
      if (rcvbuf.length() > 200)
        rcvbuf = "";
      rcvbuf += c;
      //Serial.write(c);
    }

    if (readingVal) {
      if (c != ',' ) {
        valString += c;
        //Serial.write(c);
      }
      else {
        readingVal = false;
        tempVal = valString.toInt(); // 온도값를 String에서 Integer로 변환
        Serial.print("현재 온도는 ");
        Serial.print(tempVal-273);  
        Serial.println("C 입니다.");
      }
    }
  }

  tempVal = 0;

  if (millis() - lastConnectionTime > postingInterval) { // interval 시간이 충족되었다면
    httpRequest(); //데이터 호출
  }
}

// 서버에 날씨 데이터 호출 함수
void httpRequest() {
  Serial.println();
  client.stop();

  // 제대로 서버에 연결되었을 경우
  if (client.connect(server, 80)) {
    Serial.println("Connecting...");

    // HTTP 요청을 보냄
    client.print("GET /data/2.5/weather?q=Seoul,kr&appid=");  // 서울의 날씨를 확인 (다른 지역의 날씨를 확인할려면 중간에 Seoul,kr 부분을 "지역,나라"로 바꿔주시면 됩니다.)
    //client.print("GET /data/2.5/weather?q=london,uk&appid=");  // 지역 변경 참고
    client.print(VARID);
    client.println(" HTTP/1.1");
    client.println("Host: api.openweathermap.org");
    client.println("Connection: close");
    client.println();

    // note the time that the connection was made
    lastConnectionTime = millis();
    getIsConnected = true;

  }

  // 제대로 서버에 연결이 되지 않았으면 Connection failed 메세지 출력
  else {
    Serial.println("Connection failed");
    getIsConnected = false;
  }
}

// WiFi 연결 상태 정보 출력 함수
void printWifiStatus() {
  // print the SSID of the network you're attached to
  Serial.print("SSID: ");
  Serial.println(WiFi.SSID());

  // print your WiFi shield's IP address
  IPAddress ip = WiFi.localIP();
  Serial.print("IP Address: ");
  Serial.println(ip);

  // print the received signal strength
  long rssi = WiFi.RSSI();
  Serial.print("Signal strength (RSSI):");
  Serial.print(rssi);
  Serial.println(" dBm");
}
```

#참고로 openWeatherMap사이트 내에서 검색이 되는 곳만 입력할 수있으며 지역을 벗어나면 검색 불가능 입니다.

결과적으로 입력한 지역의 현재 온도를 알 수 있습니다.

온도 습도 를 구할수 있습니다.

![2022-11-16 16;26;26](C:\Users\Jun\Desktop\2022-11-16 16;26;26.PNG)

또한 MAP에서 데이터를 호출하면 JSON형식 데이터를 응답을 받습니다.

JSON형태의 데이터란 쉽게 값,쌍,으로 이루어진 데이터 오브젝트를 전달하기위해 인간이 읽을수 있도록 텍스트를 사용하는 개방형 표준 포멧입니다. 

JSON 형태의 데이터는 받은후 전환을 위해 개발자가 함수를 통해 전환해줘야합니다.



데이터를 받고  함수를 통해 받은 데이터 값을 추출해야하며 온도가 아닌 습도나 다른것을 추출 하고자 할 경우

temp가 아닌 다른값을 입력하면 된다.

````
 if ( rcvbuf.endsWith("{\"temp\":")) {
      readingVal = true;
      valString = "";
    } 
````



## 도커

Docker를 사용하여 이 라이브러리 개발을 시작할 수도 있습니다. 첫 번째 설치 종속성:

```
docker run --rm --interactive --tty \
    --volume $PWD:/app \
    --user $(id -u):$(id -g) \
    composer update
```

그런 다음 테스트를 실행합니다.

```
docker run --rm --interactive --tty \
    --volume $PWD:/app -w /app \
    php bash

> php vendor/bin/phpunit
```

## 선적 서류 비치

문서는 [Docusaurus v2](https://docusaurus.io/) 를 사용하여 작성되었습니다 . 문서에 대한 로컬 개발 서버를 실행하려면 다음을 실행하십시오.

```
cd docs
yarn install
yarn start
```

# 특허

이 프로젝트는 MIT 라이센스에 따라 라이센스가 부여됩니다. 저작권 및 라이선스에 대한 자세한 내용은 이 소스 코드와 함께 배포 되는 [LICENSE 파일](https://github.com/Cmfcmf/OpenWeatherMap-PHP-Api/blob/master/LICENSE) 을 참조하십시오 .

OpenWeatherMap 데이터는 **MIT에 따라 라이선스가 부여되지 않습니다** . **OpenWeatherMap 서비스를 사용하기 전에 다음 공식 링크를 확인하여 OpenWeatherMap의 조건, 가격 및 라이센스에 대해 읽어보십시오.**

- [OpenWeatherMap.org/terms](http://openweathermap.org/terms)
- [OpenWeatherMap.org/appid](http://openweathermap.org/appid)

